CertQuality - Guia de Deploy em Produ√ß√£o

AWS Free Tier com Melhores Pr√°ticas 2025

üéØ Objetivo: Deploy profissional na AWS usando SSM Session Manager, sem SSH, com m√°xima seguran√ßa

---

üìã Pr√©-requisitos

* Conta AWS ativa com Free Tier
* Conhecimento b√°sico do AWS Console
* Acesso √† internet
* Navegador web moderno

---

‚òÅÔ∏è Parte 1: Configura√ß√£o IAM (Identity and Access Management)

Passo 1: Criar IAM Role para EC2 (Reutiliz√°vel)

Por que precisamos: EC2 precisa de permiss√µes para se comunicar com SSM (Session Manager) sem usar chaves SSH.

1.1 Acessar IAM:

AWS Console ‚Üí Services ‚Üí IAM ‚Üí Roles ‚Üí Create Role

1.2 Configurar Trust Relationship:

* Trusted entity type: AWS service
* Service: EC2
* Use case: EC2

O que isso faz: Permite que inst√¢ncias EC2 assumam esta role automaticamente.

1.3 Adicionar Policies (Permiss√µes):

* AmazonSSMManagedInstanceCore ‚úÖ
* CloudWatchAgentServerPolicy ‚úÖ

Explica√ß√£o das policies:

* AmazonSSMManagedInstanceCore: Permite conex√£o via Session Manager, execu√ß√£o de comandos remotos, e gerenciamento de patches
* CloudWatchAgentServerPolicy: Permite envio de logs e m√©tricas para CloudWatch

1.4 Finalizar Role:

* Role name: EC2-SSM-Role
* Description: ‚ÄúRole para EC2 com acesso SSM Session Manager‚Äù
* Create Role

Importante: Esta role pode ser reutilizada em m√∫ltiplas inst√¢ncias.

---

üñ•Ô∏è Parte 2: Lan√ßamento da Inst√¢ncia EC2

Passo 2: Configurar Inst√¢ncia EC2

2.1 Iniciar Launch Instance:

AWS Console ‚Üí EC2 ‚Üí Instances ‚Üí Launch Instance

2.2 Configura√ß√µes B√°sicas:

Name: CertQuality-Production
AMI: Ubuntu Server 24.04 LTS (Free tier eligible)
Instance type: t2.micro (Free tier)

Por que Ubuntu 24.04:

* LTS (Long Term Support) at√© 2029
* SSM Agent pr√©-instalado
* Amplo suporte da comunidade
* Atualiza√ß√µes de seguran√ßa regulares

Por que t2.micro:

* Inclu√≠do no Free Tier (750 horas/m√™s)
* Sufficient para aplica√ß√µes pequenas-m√©dias
* 1 vCPU, 1GB RAM

2.3 Key Pair (CR√çTICO):

Key pair: "Proceed without a key pair"

Por que n√£o usar SSH keys:

* SSM Session Manager √© mais seguro
* N√£o exp√µe porta 22
* Auditoria completa de acesso
* Gest√£o de acesso via IAM

2.4 Network Settings (MUITO IMPORTANTE):

Security Group Configuration:

Create security group: ‚úÖ
Security group name: certquality-production-sg
Description: Security group for CertQuality production

Inbound Rules:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Type ‚îÇ Port ‚îÇ Proto‚îÇ Source      ‚îÇ Description  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ HTTP ‚îÇ 80   ‚îÇ TCP  ‚îÇ 0.0.0.0/0   ‚îÇ Web access   ‚îÇ
‚îÇHTTPS ‚îÇ 443  ‚îÇ TCP  ‚îÇ 0.0.0.0/0   ‚îÇ Secure web   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ùå N√ÉO adicionar SSH (port 22)

Explica√ß√£o das regras:

* HTTP (80): Tr√°fego web padr√£o, permite acesso via navegador
* HTTPS (443): Tr√°fego web seguro (futuro certificado SSL)
* 0.0.0.0/0: Anywhere - permite acesso de qualquer IP (necess√°rio para aplica√ß√£o web p√∫blica)

Por que n√£o SSH (22): Usaremos SSM Session Manager, mais seguro.

2.5 Advanced Details:

IAM instance profile: EC2-SSM-Role (criada no Passo 1)

2.6 User Data (Bootstrap Script):

#!/bin/bash
# Script executado na primeira inicializa√ß√£o

# Atualizar sistema
apt-get update
apt-get upgrade -y

# SSM Agent (j√° vem no Ubuntu 24.04, mas garantir que est√° ativo)
snap install amazon-ssm-agent --classic
systemctl enable amazon-ssm-agent
systemctl start amazon-ssm-agent

# Depend√™ncias b√°sicas para compila√ß√£o
apt-get install -y curl git wget build-essential

# Log de conclus√£o
echo "Bootstrap completed at $(date)" >> /var/log/bootstrap.log

O que o User Data faz:

* Executa automaticamente na primeira inicializa√ß√£o
* Atualiza sistema operacional
* Garante que SSM Agent est√° funcionando
* Instala ferramentas essenciais
* Registra log de execu√ß√£o

2.7 Storage:

Root volume: 20 GB gp3 (m√°ximo Free Tier)
Encrypted: ‚úÖ (boa pr√°tica de seguran√ßa)

2.8 Launch Instance:

Clique ‚ÄúLaunch Instance‚Äù

Aguarde 2-3 minutos para inst√¢ncia inicializar completamente.

---

üåê Parte 3: Configura√ß√£o de IP P√∫blico (CR√çTICO)

Passo 3: Associar Elastic IP

Por que √© obrigat√≥rio: Inst√¢ncias t2.micro n√£o recebem IP p√∫blico fixo por padr√£o.

3.1 Allocate Elastic IP:

EC2 ‚Üí Elastic IPs ‚Üí Allocate Elastic IP address

3.2 Configure Elastic IP:

Public IPv4 address pool: Amazon's pool of IPv4 addresses
Network Border Group: us-east-1 (ou sua regi√£o)

Click ‚ÄúAllocate‚Äù

3.3 Associate com a Inst√¢ncia:

Actions ‚Üí Associate Elastic IP address
Instance: CertQuality-Production (sua inst√¢ncia)
Private IP address: (deixar autom√°tico)

Click ‚ÄúAssociate‚Äù

3.4 Anotar IP P√∫blico:

üìù IMPORTANTE: Anote o Elastic IP: XXX.XXX.XXX.XXX

Este IP ser√° usado durante todo o processo!

---

üîê Parte 4: Conex√£o via SSM Session Manager

Passo 4: Conectar na Inst√¢ncia

4.1 Aguardar SSM Registration:

Aguarde 3-5 minutos ap√≥s launch para SSM Agent registrar.

4.2 Verificar Disponibilidade:

Systems Manager ‚Üí Session Manager ‚Üí Start session

Deve mostrar sua inst√¢ncia CertQuality-Production.

4.3 Conectar:

Select target: CertQuality-Production
Click "Start session"

Terminal abre no navegador! üéâ

4.4 Elevar Privil√©gios:

# Voc√™ conecta como ssm-user, precisa virar root
sudo su -

Agora voc√™ √© root na inst√¢ncia.

---

üîß Parte 5: Instala√ß√£o do Stack de Tecnologia

Passo 5: Instalar Node.js 20 LTS

# Adicionar reposit√≥rio NodeSource oficial
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

# Instalar Node.js
apt-get install -y nodejs

# Verificar instala√ß√£o
node --version  # Deve mostrar v20.x.x
npm --version   # Deve mostrar 10.x.x

Por que Node.js 20:

* Vers√£o LTS mais recente
* Melhor performance com V8 engine
* Suporte completo a ES modules
* Compatibilidade com todas as depend√™ncias

Passo 6: Instalar PostgreSQL

# Instalar PostgreSQL 16
apt-get install -y postgresql postgresql-contrib

# Iniciar e habilitar servi√ßo
systemctl start postgresql
systemctl enable postgresql

# Verificar status
systemctl status postgresql  # Deve mostrar "active (running)"

Por que PostgreSQL:

* Banco relacional robusto
* Excelente performance para aplica√ß√µes web
* Suporte nativo a JSON
* ACID compliance
* Amplamente usado em produ√ß√£o

Passo 7: Instalar Nginx

# Instalar Nginx
apt-get install -y nginx

# Habilitar para iniciar no boot
systemctl enable nginx

# Verificar instala√ß√£o
nginx -v  # Deve mostrar vers√£o

Por que Nginx:

* Web server de alta performance
* Proxy reverso eficiente
* Serve arquivos est√°ticos rapidamente
* Load balancing capabilities
* SSL/TLS termination

Passo 8: Instalar PM2 (Process Manager)

# Instalar PM2 globalmente
npm install -g pm2

# Verificar instala√ß√£o
pm2 --version

Por que PM2:

* Process manager para Node.js
* Auto-restart em caso de crash
* Zero-downtime deployments
* Monitoring integrado
* Cluster mode para m√∫ltiplos cores

---

üë§ Parte 6: Configura√ß√£o de Usu√°rio da Aplica√ß√£o

Passo 9: Criar Usu√°rio com Permiss√µes Adequadas

# Criar usu√°rio da aplica√ß√£o
useradd -m -s /bin/bash appuser

# Definir senha automaticamente
echo "appuser:AppUserAWS2024!" | chpasswd

# Adicionar ao grupo sudo para opera√ß√µes administrativas
usermod -aG sudo appuser

# Configurar sudo sem senha para facilitar opera√ß√µes
echo "appuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/appuser
chmod 0440 /etc/sudoers.d/appuser

Por que um usu√°rio dedicado:

* Princ√≠pio de menor privil√©gio
* Isolamento de aplica√ß√£o
* Facilita debugging e logs
* Melhores pr√°ticas de seguran√ßa

---

üóÑÔ∏è Parte 7: Configura√ß√£o do PostgreSQL

Passo 10: Setup do Banco de Dados

# Conectar como usu√°rio postgres e configurar
sudo -u postgres psql << 'EOF'
-- Criar usu√°rio da aplica√ß√£o
CREATE USER appuser WITH PASSWORD 'SecurePasswordAWS2024!';

-- Criar banco de dados
CREATE DATABASE tenant_management_db OWNER appuser;

-- Conceder todos os privil√©gios
GRANT ALL PRIVILEGES ON DATABASE tenant_management_db TO appuser;

-- Verificar cria√ß√£o
\du
\l

-- Sair
\q
EOF

Verifica√ß√£o:

# Deve mostrar usu√°rio e banco criados
sudo -u postgres psql -l | grep tenant_management_db

Passo 11: Configurar Autentica√ß√£o Autom√°tica

# Mudar para usu√°rio appuser
su - appuser

# Criar arquivo de credenciais PostgreSQL
cat > ~/.pgpass << 'EOF'
localhost:5432:tenant_management_db:appuser:SecurePasswordAWS2024!
EOF

# Definir permiss√µes corretas (obrigat√≥rio)
chmod 600 ~/.pgpass

# Testar conex√£o
psql -h localhost -U appuser -d tenant_management_db -c "SELECT version();"

Deve conectar sem pedir senha e mostrar vers√£o do PostgreSQL.

Se pedir senha: Arquivo .pgpass est√° incorreto.

---

üìÅ Parte 8: Deploy da Aplica√ß√£o

Passo 12: Clonar e Configurar Projeto

# Como appuser, clonar reposit√≥rio
cd ~
git clone https://github.com/mcsafx/CertificateManager-Production.git CertificateManager
cd CertificateManager

# Verificar estrutura
ls -la

Passo 13: Configurar Vari√°veis de Ambiente

# Criar arquivo .env com configura√ß√µes de produ√ß√£o
cat > .env << EOF
# Database Configuration
DATABASE_URL="postgresql://appuser:SecurePasswordAWS2024!@localhost:5432/tenant_management_db"

# Environment
NODE_ENV=production

# Server Configuration
PORT=5000

# Session Security
SESSION_SECRET="$(openssl rand -base64 48)"

# Frontend API URL - SUBSTITUIR PELO SEU ELASTIC IP
VITE_API_URL=http://XXX.XXX.XXX.XXX
EOF

# ‚ö†Ô∏è IMPORTANTE: Substituir XXX.XXX.XXX.XXX pelo Elastic IP real
# Exemplo: sed -i 's/XXX.XXX.XXX.XXX/54.234.34.153/g' .env

Verificar .env:

cat .env
# Confirmar que VITE_API_URL tem IP correto

Passo 14: Instalar Depend√™ncias

# Instalar todas as depend√™ncias
npm install

# Processo pode demorar 3-5 minutos
# Ir√° compilar packages nativos para Linux

O que acontece:

* Download de todas as depend√™ncias do package.json
* Compila√ß√£o de packages nativos (bcrypt, etc.)
* Setup de ferramentas de build (Vite, TypeScript)
* Cria√ß√£o de node_modules

---

üóÑÔ∏è Parte 9: Configura√ß√£o do Banco de Dados

Passo 15: Executar Migra√ß√µes

# Executar push do schema para o banco
npm run db:push

O que executa:

* Drizzle Kit l√™ configura√ß√£o em drizzle.config.ts
* Conecta no PostgreSQL usando DATABASE_URL
* L√™ schema definitions em shared/schema.ts
* Cria todas as tabelas necess√°rias
* Aplica indexes e constraints

Sa√≠da esperada:

No config path provided, using default 'drizzle.config.ts'
Reading config file...
Using 'pg' driver for database querying
‚úì Changes applied

Passo 16: Popular com Dados Iniciais

# Verificar se script existe
ls -la scripts/initial-data.sql

# Executar script de dados iniciais
psql -h localhost -U appuser -d tenant_management_db < scripts/initial-data.sql

Deve mostrar:

INSERT 0 3  (planos inseridos)
INSERT 0 5  (m√≥dulos inseridos)

Passo 17: Verificar Dados

# Verificar planos
psql -h localhost -U appuser -d tenant_management_db -c "
SELECT code, name, price FROM plans ORDER BY code;
"

# Verificar m√≥dulos
psql -h localhost -U appuser -d tenant_management_db -c "
SELECT code, name, is_core FROM modules ORDER BY code;
"

---

üèóÔ∏è Parte 10: Build e Deploy da Aplica√ß√£o

Passo 18: Build de Produ√ß√£o

# Compilar frontend e backend para produ√ß√£o
npm run build

O que acontece:

* Frontend: Vite compila React + TypeScript ‚Üí arquivos est√°ticos otimizados
* Backend: esbuild compila TypeScript ‚Üí JavaScript otimizado
* Assets: Minifica√ß√£o, tree-shaking, code splitting
* Output: Arquivos prontos para produ√ß√£o em dist/

Sa√≠da esperada:

vite v5.x.x building for production...
‚úì 2697 modules transformed.
dist/public/index.html                    1.80 kB
dist/public/assets/index-xxxxx.css       66.25 kB
dist/public/assets/index-xxxxx.js     1,235.54 kB
‚úì built in 38.98s

dist/index.js  249.1kb
‚ö° Done in 87ms

Passo 19: Configurar Script de Inicializa√ß√£o

# Criar script de start otimizado
cat > start.sh << 'EOF'
#!/bin/bash
cd /home/appuser/CertificateManager
NODE_ENV=production node dist/index.js
EOF

# Tornar execut√°vel
chmod +x start.sh

Passo 20: Iniciar com PM2

# Iniciar aplica√ß√£o com PM2
pm2 start ./start.sh --name certquality-production

# Verificar status
pm2 status

Deve mostrar:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id ‚îÇ name                ‚îÇ mode    ‚îÇ ‚Ü∫       ‚îÇ status   ‚îÇ cpu    ‚îÇ mem  ‚îÇ user     ‚îÇ watching ‚îÇ uptime   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0  ‚îÇ certquality-prod... ‚îÇ fork    ‚îÇ 0       ‚îÇ online   ‚îÇ 0%     ‚îÇ 32mb ‚îÇ appuser  ‚îÇ disabled ‚îÇ 2s       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Passo 21: Verificar Logs da Aplica√ß√£o

# Ver logs detalhados
pm2 logs certquality-production --lines 15

Logs esperados (sem erros):

[express] serving on port 5000
Verificando status de todas as assinaturas...
Verificador de assinaturas iniciado. Intervalo: a cada 6 horas
Admin tenant created successfully (first-time initialization)
Admin user created successfully

Passo 22: Salvar Configura√ß√£o PM2

# Salvar configura√ß√£o atual
pm2 save

# Testar aplica√ß√£o localmente
curl http://localhost:5000

Deve retornar: HTML da aplica√ß√£o

---

üîß Parte 11: Configura√ß√£o do PM2 Startup

Passo 23: Configurar Auto-start

# Sair para root
exit

# Configurar PM2 para iniciar automaticamente
env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u appuser --hp /home/appuser

O comando acima gera uma linha que voc√™ deve copiar e executar.

Exemplo de sa√≠da:

[PM2] You have to run this command as root. Execute the following command:
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u appuser --hp /home/appuser

Execute a linha mostrada pelo PM2.

---

üåê Parte 12: Configura√ß√£o do Nginx

Passo 24: Configurar Proxy Reverso

# Como root, criar configura√ß√£o do site
cat > /etc/nginx/sites-available/certquality << 'EOF'
server {
    # Escutar na porta 80 (HTTP padr√£o)
    listen 80;
    server_name _;

    # Configura√ß√£o do proxy reverso
    location / {
        # Encaminhar requests para aplica√ß√£o Node.js
        proxy_pass http://localhost:5000;
        
        # Headers necess√°rios para aplica√ß√µes web modernas
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Configura√ß√µes adicionais
    client_max_body_size 50M;
    
    # Logs espec√≠ficos do site
    access_log /var/log/nginx/certquality.access.log;
    error_log /var/log/nginx/certquality.error.log;
}
EOF

Explica√ß√£o da configura√ß√£o:

* listen 80: Nginx escuta na porta padr√£o web
* proxy_pass: Encaminha requests para aplica√ß√£o na porta 5000
* proxy_set_header: Headers necess√°rios para aplica√ß√£o funcionar corretamente
* client_max_body_size: Permite uploads de at√© 50MB

Passo 25: Ativar Site

# Criar link simb√≥lico para ativar site
ln -s /etc/nginx/sites-available/certquality /etc/nginx/sites-enabled/

# Remover site padr√£o
rm -f /etc/nginx/sites-enabled/default

# Testar configura√ß√£o
nginx -t

Deve mostrar:

nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

Passo 26: Reiniciar Nginx

# Reiniciar Nginx para aplicar configura√ß√µes
systemctl restart nginx

# Verificar status
systemctl status nginx

Status deve mostrar: ‚Äúactive (running)‚Äù

---

‚úÖ Parte 13: Verifica√ß√µes e Testes Finais

Passo 27: Testes de Conectividade

# Testar aplica√ß√£o localmente
curl http://localhost
curl -I http://localhost  # Deve mostrar headers do Nginx

# Verificar IP p√∫blico da inst√¢ncia
curl http://169.254.169.254/latest/meta-data/public-ipv4
# Deve retornar o Elastic IP associado

# Testar acesso externo
curl http://SEU-ELASTIC-IP

Passo 28: Verificar Todos os Servi√ßos

# PostgreSQL
systemctl status postgresql  # active (running)

# Nginx
systemctl status nginx       # active (running)

# PM2 (como appuser)
su - appuser
pm2 status                   # online, 0 restarts

# Logs da aplica√ß√£o
pm2 logs certquality-production --lines 10

---

üåê Parte 14: Acesso Final

Passo 29: Acessar Aplica√ß√£o

URL: http://SEU-ELASTIC-IP

Passo 30: Fazer Login

Credenciais padr√£o:

* Username: admin
* Password: admin123

Interface esperada:

* ‚úÖ Dashboard CertQuality carregando
* ‚úÖ Menu lateral funcionando
* ‚úÖ M√©tricas sendo exibidas
* ‚úÖ Sistema responsivo

---

üîß Parte 15: Otimiza√ß√µes para Free Tier

Passo 31: Configurar Swap (t2.micro)

# Como root, adicionar swap para melhor performance
fallocate -l 1G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# Tornar permanente
echo '/swapfile none swap sw 0 0' >> /etc/fstab

# Otimizar uso de swap
sysctl vm.swappiness=10
echo 'vm.swappiness=10' >> /etc/sysctl.conf

Por que adicionar swap:

* t2.micro tem apenas 1GB RAM
* Evita out-of-memory errors
* Melhora performance geral

Passo 32: Configurar Logrotate

# Configurar rota√ß√£o de logs para economizar espa√ßo
cat > /etc/logrotate.d/certquality << 'EOF'
/var/log/nginx/certquality.*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 640 www-data adm
    sharedscripts
    postrotate
        systemctl reload nginx
    endscript
}

/home/appuser/.pm2/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF

---

üìä Monitoring e Manuten√ß√£o

Comandos √öteis para Monitoramento:

# Status geral do sistema
top
htop  # Se instalado: apt install htop

# Uso de disco
df -h

# Uso de mem√≥ria
free -h

# Logs do sistema
journalctl -u nginx.service --since "1 hour ago"
journalctl -u postgresql.service --since "1 hour ago"

# Logs da aplica√ß√£o
su - appuser
pm2 logs certquality-production
pm2 monit  # Interface de monitoramento

Backup Autom√°tico (Opcional):

# Script de backup do banco
cat > /home/appuser/backup-db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/home/appuser/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
pg_dump -h localhost -U appuser -d tenant_management_db > $BACKUP_DIR/backup_$DATE.sql
gzip $BACKUP_DIR/backup_$DATE.sql

# Manter apenas 7 backups
ls -t $BACKUP_DIR/backup_*.sql.gz | tail -n +8 | xargs rm -f
EOF

chmod +x /home/appuser/backup-db.sh

# Adicionar ao crontab (executa diariamente √†s 2:00 AM)
echo "0 2 * * * /home/appuser/backup-db.sh" | crontab -u appuser -

---

üêõ Troubleshooting

Problema: ‚ÄúFailed to connect‚Äù no navegador

Causas poss√≠veis:

1. Security Group n√£o permite HTTP (80)
2. Elastic IP n√£o associado
3. Nginx n√£o est√° rodando

Solu√ß√µes:

# Verificar Security Group no AWS Console
# Verificar Elastic IP associado
# Verificar Nginx
systemctl status nginx
systemctl restart nginx

Problema: ‚Äú502 Bad Gateway‚Äù

Causa: Nginx funcionando, mas aplica√ß√£o Node.js parada

Solu√ß√£o:

su - appuser
pm2 status
pm2 restart certquality-production
pm2 logs certquality-production

Problema: ‚ÄúDatabase connection failed‚Äù

Causa: PostgreSQL parado ou configura√ß√£o incorreta

Solu√ß√£o:

systemctl status postgresql
systemctl restart postgresql

# Testar conex√£o manualmente
su - appuser
psql -h localhost -U appuser -d tenant_management_db -c "SELECT 1;"

---

üí∞ Limites do Free Tier

Monitoramento de Uso:

* EC2: 750 horas/m√™s (uma inst√¢ncia t2.micro 24/7)
* EBS: 30GB storage
* Data Transfer: 15GB/m√™s out
* Elastic IP: Gr√°tis quando associado

Como Monitorar:

AWS Console ‚Üí Billing ‚Üí Free Tier Usage

Alertas de Billing:

AWS Console ‚Üí Billing ‚Üí Billing preferences ‚Üí Receive Billing Alerts
CloudWatch ‚Üí Alarms ‚Üí Create Alarm ‚Üí Billing

---

‚úÖ Checklist de Sucesso Completo

Infraestrutura AWS:

[ ] IAM Role criada com permiss√µes SSM
[ ] EC2 t2.micro lan√ßada com Ubuntu 24.04
[ ] Security Group com HTTP (80) e HTTPS (443)
[ ] Elastic IP associado
[ ] SSM Session Manager funcionando

Software Stack:

[ ] Node.js 20.x instalado
[ ] PostgreSQL 16 rodando
[ ] Nginx configurado como proxy reverso
[ ] PM2 gerenciando processo da aplica√ß√£o

Aplica√ß√£o:

[ ] C√≥digo clonado e depend√™ncias instaladas
[ ] Banco migrado e populado com dados
[ ] Build de produ√ß√£o executado
[ ] PM2 mostrando status ‚Äúonline‚Äù
[ ] Logs sem erros de conex√£o

Produ√ß√£o:

[ ] Aplica√ß√£o acess√≠vel via Elastic IP
[ ] Login funcionando
[ ] Interface carregando corretamente
[ ] Auto-restart configurado (PM2 + systemd)

---

üéØ Resultados Esperados

Ap√≥s seguir este guia completamente, voc√™ ter√°:

‚úÖ Aplica√ß√£o Profissional em Produ√ß√£o:

* Sistema CertQuality rodando 24/7
* Performance otimizada para produ√ß√£o
* Resistente a crashes (auto-restart)
* Logs centralizados e organizados

‚úÖ Infraestrutura Segura:

* Sem exposi√ß√£o SSH (porta 22)
* Acesso auditado via SSM
* Princ√≠pio de menor privil√©gio
* Backups automatizados

‚úÖ Custo Zero:

* 100% dentro do AWS Free Tier
* Monitoramento de uso ativo
* Alertas configurados

‚úÖ Manutenibilidade:

* Comandos de monitoramento
* Logs organizados
* Procedimentos de backup
* Troubleshooting documentado

Deploy profissional na AWS com zero custo! üöÄ

---

üîÑ Pr√≥ximos Passos (Opcionais)

SSL/HTTPS (Certificado Gr√°tis):

* Configurar Route 53 + ACM
* Certificado SSL autom√°tico
* Redirect HTTP ‚Üí HTTPS

Monitoramento Avan√ßado:

* CloudWatch Dashboards
* SNS notifications
* Custom metrics

CI/CD Pipeline:

* GitHub Actions
* Deploy automatizado
* Testing pipeline

Scaling:

* Application Load Balancer
* Multiple availability zones
* Auto Scaling Groups

Base s√≥lida para expans√£o futura! üéØ